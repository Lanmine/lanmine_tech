apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: snmp-exporter
  namespace: snmp-exporter
  labels:
    app: snmp-exporter
    release: kube-prometheus-stack
spec:
  selector:
    matchLabels:
      app: snmp-exporter
  endpoints:
    - port: http
      interval: 60s
      scrapeTimeout: 30s
      path: /snmp
      params:
        module: [if_mib]
        auth: [cisco_v2]
      relabelings:
        # Use static targets for now (mgmt-sw-01)
        - sourceLabels: []
          targetLabel: __address__
          replacement: 10.0.99.101:161
        # Replace instance label with switch hostname
        - sourceLabels: [__address__]
          targetLabel: __param_target
        - sourceLabels: [__param_target]
          targetLabel: instance
          replacement: mgmt-sw-01
        # Point to SNMP exporter service
        - targetLabel: __address__
          replacement: snmp-exporter.snmp-exporter.svc.cluster.local:9116
      metricRelabelings:
        # Add switch_name label
        - sourceLabels: [instance]
          targetLabel: switch_name
