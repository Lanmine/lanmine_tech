---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: monitoring-alerts
  namespace: monitoring
  labels:
    release: kube-prometheus-stack
spec:
  groups:
  - name: snmp-devices
    rules:
    - alert: SNMPDeviceDown
      annotations:
        description: 'SNMP device {{ $labels.device }} ({{ $labels.instance }}) has been unreachable for more than 5 minutes.'
        summary: 'SNMP device down: {{ $labels.device }}'
      expr: up{job="snmp"} == 0
      for: 5m
      labels:
        severity: critical

    - alert: SNMPDeviceHighUptime
      annotations:
        description: 'SNMP device {{ $labels.device }} has been up for {{ $value | humanizeDuration }}. Consider scheduling maintenance.'
        summary: 'SNMP device high uptime: {{ $labels.device }}'
      expr: sysUpTime{job="snmp"} / 100 > 31536000  # 365 days in seconds
      for: 1h
      labels:
        severity: info

  - name: linux-vms
    rules:
    - alert: LinuxVMDown
      annotations:
        description: 'Linux VM {{ $labels.instance }} has been unreachable for more than 5 minutes.'
        summary: 'Linux VM down: {{ $labels.instance }}'
      expr: up{job="node-exporter"} == 0
      for: 5m
      labels:
        severity: critical

    - alert: LinuxVMHighCPUUsage
      annotations:
        description: 'Linux VM {{ $labels.instance }} CPU usage is {{ $value | printf "%.1f" }}% (threshold: 85%).'
        summary: 'High CPU usage on VM: {{ $labels.instance }}'
      expr: |
        100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle",job="node-exporter"}[5m])) * 100) > 85
      for: 10m
      labels:
        severity: warning

    - alert: LinuxVMHighMemoryUsage
      annotations:
        description: 'Linux VM {{ $labels.instance }} memory usage is {{ $value | printf "%.1f" }}% (threshold: 85%).'
        summary: 'High memory usage on VM: {{ $labels.instance }}'
      expr: |
        (1 - (node_memory_MemAvailable_bytes{job="node-exporter"} / node_memory_MemTotal_bytes{job="node-exporter"})) * 100 > 85
      for: 10m
      labels:
        severity: warning

    - alert: LinuxVMHighDiskUsage
      annotations:
        description: 'Linux VM {{ $labels.instance }} disk {{ $labels.mountpoint }} usage is {{ $value | printf "%.1f" }}% (threshold: 85%).'
        summary: 'High disk usage on VM: {{ $labels.instance }}{{ $labels.mountpoint }}'
      expr: |
        100 - ((node_filesystem_avail_bytes{job="node-exporter",mountpoint="/",fstype!="rootfs"} * 100) / node_filesystem_size_bytes{job="node-exporter",mountpoint="/",fstype!="rootfs"}) > 85
      for: 10m
      labels:
        severity: warning

    - alert: LinuxVMCriticalDiskUsage
      annotations:
        description: 'Linux VM {{ $labels.instance }} disk {{ $labels.mountpoint }} usage is {{ $value | printf "%.1f" }}% (threshold: 95%).'
        summary: 'Critical disk usage on VM: {{ $labels.instance }}{{ $labels.mountpoint }}'
      expr: |
        100 - ((node_filesystem_avail_bytes{job="node-exporter",mountpoint="/",fstype!="rootfs"} * 100) / node_filesystem_size_bytes{job="node-exporter",mountpoint="/",fstype!="rootfs"}) > 95
      for: 5m
      labels:
        severity: critical

    - alert: LinuxVMHighLoadAverage
      annotations:
        description: 'Linux VM {{ $labels.instance }} load average (15m) is {{ $value | printf "%.2f" }}, exceeding CPU count.'
        summary: 'High load average on VM: {{ $labels.instance }}'
      expr: |
        node_load15{job="node-exporter"} / count without(cpu, mode) (node_cpu_seconds_total{mode="idle",job="node-exporter"}) > 1.5
      for: 15m
      labels:
        severity: warning

    - alert: LinuxVMDiskWillFillIn24Hours
      annotations:
        description: 'Linux VM {{ $labels.instance }} disk {{ $labels.mountpoint }} is predicted to fill within 24 hours based on current growth rate.'
        summary: 'Disk filling soon on VM: {{ $labels.instance }}{{ $labels.mountpoint }}'
      expr: |
        predict_linear(node_filesystem_avail_bytes{job="node-exporter",mountpoint="/",fstype!="rootfs"}[1h], 24*3600) < 0
      for: 1h
      labels:
        severity: warning

    - alert: LinuxVMOutOfInodes
      annotations:
        description: 'Linux VM {{ $labels.instance }} filesystem {{ $labels.mountpoint }} has less than 10% inodes available.'
        summary: 'Out of inodes on VM: {{ $labels.instance }}{{ $labels.mountpoint }}'
      expr: |
        (node_filesystem_files_free{job="node-exporter",mountpoint="/",fstype!="rootfs"} / node_filesystem_files{job="node-exporter",mountpoint="/",fstype!="rootfs"}) * 100 < 10
      for: 10m
      labels:
        severity: warning

  - name: network-interfaces
    rules:
    - alert: NetworkInterfaceDown
      annotations:
        description: 'Network interface {{ $labels.ifIndex }} on {{ $labels.device }} is operationally down.'
        summary: 'Interface down: {{ $labels.device }}/if{{ $labels.ifIndex }}'
      expr: ifOperStatus{job="snmp",ifAdminStatus="1"} == 2
      for: 5m
      labels:
        severity: warning

    - alert: NetworkInterfaceHighTrafficIn
      annotations:
        description: 'Interface {{ $labels.ifIndex }} on {{ $labels.device }} inbound traffic is {{ $value | printf "%.1f" }}% of capacity.'
        summary: 'High inbound traffic: {{ $labels.device }}/if{{ $labels.ifIndex }}'
      expr: |
        (irate(ifHCInOctets{job="snmp"}[5m]) * 8) / (ifHighSpeed{job="snmp"} * 1000000) * 100 > 80
        and ifHighSpeed{job="snmp"} > 0
      for: 10m
      labels:
        severity: warning

    - alert: NetworkInterfaceHighTrafficOut
      annotations:
        description: 'Interface {{ $labels.ifIndex }} on {{ $labels.device }} outbound traffic is {{ $value | printf "%.1f" }}% of capacity.'
        summary: 'High outbound traffic: {{ $labels.device }}/if{{ $labels.ifIndex }}'
      expr: |
        (irate(ifHCOutOctets{job="snmp"}[5m]) * 8) / (ifHighSpeed{job="snmp"} * 1000000) * 100 > 80
        and ifHighSpeed{job="snmp"} > 0
      for: 10m
      labels:
        severity: warning

    - alert: NetworkInterfaceErrors
      annotations:
        description: 'Interface {{ $labels.ifIndex }} on {{ $labels.device }} has {{ $value | printf "%.0f" }} errors in the last 5 minutes.'
        summary: 'Interface errors: {{ $labels.device }}/if{{ $labels.ifIndex }}'
      expr: |
        increase(ifInErrors{job="snmp"}[5m]) + increase(ifOutErrors{job="snmp"}[5m]) > 10
      for: 5m
      labels:
        severity: warning
