---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: monitoring-alerts
  namespace: monitoring
  labels:
    release: kube-prometheus-stack
spec:
  groups:
  - name: snmp-devices
    rules:
    - alert: SNMPDeviceDown
      annotations:
        description: 'SNMP device {{ $labels.device }} ({{ $labels.instance }}) has been unreachable for more than 5 minutes.'
        summary: 'SNMP device down: {{ $labels.device }}'
      expr: up{job="snmp"} == 0
      for: 5m
      labels:
        severity: critical

    - alert: SNMPDeviceHighUptime
      annotations:
        description: 'SNMP device {{ $labels.device }} has been up for {{ $value | humanizeDuration }}. Consider scheduling maintenance.'
        summary: 'SNMP device high uptime: {{ $labels.device }}'
      expr: sysUpTime{job="snmp"} / 100 > 31536000  # 365 days in seconds
      for: 1h
      labels:
        severity: info

  - name: linux-vms
    rules:
    - alert: LinuxVMDown
      annotations:
        description: 'Linux VM {{ $labels.instance }} has been unreachable for more than 5 minutes.'
        summary: 'Linux VM down: {{ $labels.instance }}'
      expr: up{job="node-exporter"} == 0
      for: 5m
      labels:
        severity: critical

    - alert: LinuxVMHighCPUUsage
      annotations:
        description: 'Linux VM {{ $labels.instance }} CPU usage is {{ $value | printf "%.1f" }}% (threshold: 85%).'
        summary: 'High CPU usage on VM: {{ $labels.instance }}'
      expr: |
        100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle",job="node-exporter"}[5m])) * 100) > 85
      for: 10m
      labels:
        severity: warning

    - alert: LinuxVMHighMemoryUsage
      annotations:
        description: 'Linux VM {{ $labels.instance }} memory usage is {{ $value | printf "%.1f" }}% (threshold: 85%).'
        summary: 'High memory usage on VM: {{ $labels.instance }}'
      expr: |
        (1 - (node_memory_MemAvailable_bytes{job="node-exporter"} / node_memory_MemTotal_bytes{job="node-exporter"})) * 100 > 85
      for: 10m
      labels:
        severity: warning

    - alert: LinuxVMHighDiskUsage
      annotations:
        description: 'Linux VM {{ $labels.instance }} disk {{ $labels.mountpoint }} usage is {{ $value | printf "%.1f" }}% (threshold: 85%).'
        summary: 'High disk usage on VM: {{ $labels.instance }}{{ $labels.mountpoint }}'
      expr: |
        100 - ((node_filesystem_avail_bytes{job="node-exporter",mountpoint="/",fstype!="rootfs"} * 100) / node_filesystem_size_bytes{job="node-exporter",mountpoint="/",fstype!="rootfs"}) > 85
      for: 10m
      labels:
        severity: warning

    - alert: LinuxVMCriticalDiskUsage
      annotations:
        description: 'Linux VM {{ $labels.instance }} disk {{ $labels.mountpoint }} usage is {{ $value | printf "%.1f" }}% (threshold: 95%).'
        summary: 'Critical disk usage on VM: {{ $labels.instance }}{{ $labels.mountpoint }}'
      expr: |
        100 - ((node_filesystem_avail_bytes{job="node-exporter",mountpoint="/",fstype!="rootfs"} * 100) / node_filesystem_size_bytes{job="node-exporter",mountpoint="/",fstype!="rootfs"}) > 95
      for: 5m
      labels:
        severity: critical

    - alert: LinuxVMHighLoadAverage
      annotations:
        description: 'Linux VM {{ $labels.instance }} load average (15m) is {{ $value | printf "%.2f" }}, exceeding CPU count.'
        summary: 'High load average on VM: {{ $labels.instance }}'
      expr: |
        node_load15{job="node-exporter"} / count without(cpu, mode) (node_cpu_seconds_total{mode="idle",job="node-exporter"}) > 1.5
      for: 15m
      labels:
        severity: warning

    - alert: LinuxVMDiskWillFillIn24Hours
      annotations:
        description: 'Linux VM {{ $labels.instance }} disk {{ $labels.mountpoint }} is predicted to fill within 24 hours based on current growth rate.'
        summary: 'Disk filling soon on VM: {{ $labels.instance }}{{ $labels.mountpoint }}'
      expr: |
        predict_linear(node_filesystem_avail_bytes{job="node-exporter",mountpoint="/",fstype!="rootfs"}[1h], 24*3600) < 0
      for: 1h
      labels:
        severity: warning

    - alert: LinuxVMOutOfInodes
      annotations:
        description: 'Linux VM {{ $labels.instance }} filesystem {{ $labels.mountpoint }} has less than 10% inodes available.'
        summary: 'Out of inodes on VM: {{ $labels.instance }}{{ $labels.mountpoint }}'
      expr: |
        (node_filesystem_files_free{job="node-exporter",mountpoint="/",fstype!="rootfs"} / node_filesystem_files{job="node-exporter",mountpoint="/",fstype!="rootfs"}) * 100 < 10
      for: 10m
      labels:
        severity: warning

  - name: network-interfaces
    rules:
    - alert: NetworkInterfaceDown
      annotations:
        description: 'Network interface {{ $labels.ifIndex }} on {{ $labels.device }} is operationally down.'
        summary: 'Interface down: {{ $labels.device }}/if{{ $labels.ifIndex }}'
      expr: ifOperStatus{job="snmp",ifAdminStatus="1"} == 2
      for: 5m
      labels:
        severity: warning

    - alert: NetworkInterfaceHighTrafficIn
      annotations:
        description: 'Interface {{ $labels.ifIndex }} on {{ $labels.device }} inbound traffic is {{ $value | printf "%.1f" }}% of capacity.'
        summary: 'High inbound traffic: {{ $labels.device }}/if{{ $labels.ifIndex }}'
      expr: |
        (irate(ifHCInOctets{job="snmp"}[5m]) * 8) / (ifHighSpeed{job="snmp"} * 1000000) * 100 > 80
        and ifHighSpeed{job="snmp"} > 0
      for: 10m
      labels:
        severity: warning

    - alert: NetworkInterfaceHighTrafficOut
      annotations:
        description: 'Interface {{ $labels.ifIndex }} on {{ $labels.device }} outbound traffic is {{ $value | printf "%.1f" }}% of capacity.'
        summary: 'High outbound traffic: {{ $labels.device }}/if{{ $labels.ifIndex }}'
      expr: |
        (irate(ifHCOutOctets{job="snmp"}[5m]) * 8) / (ifHighSpeed{job="snmp"} * 1000000) * 100 > 80
        and ifHighSpeed{job="snmp"} > 0
      for: 10m
      labels:
        severity: warning

    - alert: NetworkInterfaceErrors
      annotations:
        description: 'Interface {{ $labels.ifIndex }} on {{ $labels.device }} has {{ $value | printf "%.0f" }} errors in the last 5 minutes.'
        summary: 'Interface errors: {{ $labels.device }}/if{{ $labels.ifIndex }}'
      expr: |
        increase(ifInErrors{job="snmp"}[5m]) + increase(ifOutErrors{job="snmp"}[5m]) > 10
      for: 5m
      labels:
        severity: warning

  - name: certificates
    rules:
    - alert: CertificateExpiringSoon
      annotations:
        description: 'Certificate {{ $labels.name }} in namespace {{ $labels.namespace }} expires in {{ $value | humanizeDuration }}.'
        summary: 'Certificate expiring soon: {{ $labels.namespace }}/{{ $labels.name }}'
      expr: |
        certmanager_certificate_expiration_timestamp_seconds - time() < 14 * 24 * 3600
        and certmanager_certificate_expiration_timestamp_seconds - time() > 0
      for: 1h
      labels:
        severity: warning

    - alert: CertificateExpiryCritical
      annotations:
        description: 'Certificate {{ $labels.name }} in namespace {{ $labels.namespace }} expires in {{ $value | humanizeDuration }}. Immediate action required.'
        summary: 'Certificate expiring critically soon: {{ $labels.namespace }}/{{ $labels.name }}'
      expr: |
        certmanager_certificate_expiration_timestamp_seconds - time() < 7 * 24 * 3600
        and certmanager_certificate_expiration_timestamp_seconds - time() > 0
      for: 1h
      labels:
        severity: critical

    - alert: CertificateExpired
      annotations:
        description: 'Certificate {{ $labels.name }} in namespace {{ $labels.namespace }} has expired.'
        summary: 'Certificate expired: {{ $labels.namespace }}/{{ $labels.name }}'
      expr: |
        certmanager_certificate_expiration_timestamp_seconds - time() < 0
      for: 5m
      labels:
        severity: critical

    - alert: CertificateNotReady
      annotations:
        description: 'Certificate {{ $labels.name }} in namespace {{ $labels.namespace }} is not ready.'
        summary: 'Certificate not ready: {{ $labels.namespace }}/{{ $labels.name }}'
      expr: |
        certmanager_certificate_ready_status{condition="False"} == 1
      for: 15m
      labels:
        severity: warning

  - name: kubernetes-pods
    rules:
    - alert: PodCrashLooping
      annotations:
        description: 'Pod {{ $labels.namespace }}/{{ $labels.pod }} is crash looping ({{ $value | printf "%.0f" }} restarts in the last hour).'
        summary: 'Pod crash looping: {{ $labels.namespace }}/{{ $labels.pod }}'
      expr: |
        increase(kube_pod_container_status_restarts_total[1h]) > 5
      for: 15m
      labels:
        severity: warning

    - alert: PodNotReady
      annotations:
        description: 'Pod {{ $labels.namespace }}/{{ $labels.pod }} has been not ready for more than 15 minutes.'
        summary: 'Pod not ready: {{ $labels.namespace }}/{{ $labels.pod }}'
      expr: |
        kube_pod_status_phase{phase=~"Pending|Unknown"} == 1
      for: 15m
      labels:
        severity: warning

    - alert: ContainerOOMKilled
      annotations:
        description: 'Container {{ $labels.container }} in pod {{ $labels.namespace }}/{{ $labels.pod }} was OOM killed.'
        summary: 'Container OOM killed: {{ $labels.namespace }}/{{ $labels.pod }}/{{ $labels.container }}'
      expr: |
        kube_pod_container_status_last_terminated_reason{reason="OOMKilled"} == 1
      for: 0m
      labels:
        severity: warning

  - name: kubernetes-storage
    rules:
    - alert: PVCAlmostFull
      annotations:
        description: 'PVC {{ $labels.namespace }}/{{ $labels.persistentvolumeclaim }} is {{ $value | printf "%.1f" }}% full.'
        summary: 'PVC almost full: {{ $labels.namespace }}/{{ $labels.persistentvolumeclaim }}'
      expr: |
        (kubelet_volume_stats_used_bytes / kubelet_volume_stats_capacity_bytes) * 100 > 85
      for: 15m
      labels:
        severity: warning

    - alert: PVCCriticallyFull
      annotations:
        description: 'PVC {{ $labels.namespace }}/{{ $labels.persistentvolumeclaim }} is {{ $value | printf "%.1f" }}% full. Immediate action required.'
        summary: 'PVC critically full: {{ $labels.namespace }}/{{ $labels.persistentvolumeclaim }}'
      expr: |
        (kubelet_volume_stats_used_bytes / kubelet_volume_stats_capacity_bytes) * 100 > 95
      for: 5m
      labels:
        severity: critical

    - alert: PVCInodesCritical
      annotations:
        description: 'PVC {{ $labels.namespace }}/{{ $labels.persistentvolumeclaim }} has only {{ $value | printf "%.1f" }}% inodes available.'
        summary: 'PVC low inodes: {{ $labels.namespace }}/{{ $labels.persistentvolumeclaim }}'
      expr: |
        (kubelet_volume_stats_inodes_free / kubelet_volume_stats_inodes) * 100 < 10
      for: 15m
      labels:
        severity: warning

  - name: velero-backups
    rules:
    - alert: VeleroBackupFailed
      annotations:
        description: 'Velero backup {{ $labels.schedule }} failed. Check velero logs for details.'
        summary: 'Velero backup failed: {{ $labels.schedule }}'
      expr: |
        increase(velero_backup_failure_total[1h]) > 0
      for: 5m
      labels:
        severity: critical

    - alert: VeleroBackupPartiallyFailed
      annotations:
        description: 'Velero backup {{ $labels.schedule }} partially failed with some items not backed up.'
        summary: 'Velero backup partially failed: {{ $labels.schedule }}'
      expr: |
        increase(velero_backup_partial_failure_total[1h]) > 0
      for: 5m
      labels:
        severity: warning

    - alert: VeleroNoRecentBackup
      annotations:
        description: 'No successful Velero backup in the last 25 hours. Check if backups are running.'
        summary: 'No recent Velero backup'
      expr: |
        time() - velero_backup_last_successful_timestamp{schedule="daily-full-backup"} > 90000
      for: 1h
      labels:
        severity: warning

    - alert: VeleroBackupStorageLocationUnavailable
      annotations:
        description: 'Velero backup storage location {{ $labels.name }} is unavailable.'
        summary: 'Backup storage unavailable: {{ $labels.name }}'
      expr: |
        velero_backup_storage_location_available == 0
      for: 15m
      labels:
        severity: critical
