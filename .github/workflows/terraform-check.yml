name: Terraform Check

on:
  workflow_dispatch:
  push:
    branches: [dev]
  pull_request:
    branches: [main]

env:
  # Using Tailscale hostname for valid Let's Encrypt TLS certificate
  VAULT_ADDR: "https://vault-01.lionfish-caiman.ts.net:8200"

jobs:
  check:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Terraform Format Check
        working-directory: terraform
        run: terraform fmt -check -diff

      - name: Vault Login
        run: |
          vault write -field=token auth/approle/login \
            role_id=${{ secrets.VAULT_ROLE_ID }} \
            secret_id=${{ secrets.VAULT_SECRET_ID }} > .vault-token
          echo "VAULT_TOKEN=$(cat .vault-token)" >> $GITHUB_ENV
          rm .vault-token

      - name: Load Secrets from Vault
        run: |
          # Proxmox credentials
          TF_VAR_proxmox_api_url="$(vault kv get -field=api_url secret/infrastructure/proxmox)"
          TOKEN_ID="$(vault kv get -field=api_token_id secret/infrastructure/proxmox)"
          TOKEN_SECRET="$(vault kv get -field=api_token_secret secret/infrastructure/proxmox)"
          TF_VAR_proxmox_api_token="${TOKEN_ID}=${TOKEN_SECRET}"

          # SSH key
          TF_VAR_ssh_public_key="$(vault kv get -field=public_key secret/infrastructure/ssh)"

          # PostgreSQL backend
          PG_CONN_STR="$(vault kv get -field=connection_string secret/infrastructure/postgres)"

          # Export to GitHub environment
          echo "TF_VAR_proxmox_api_url=${TF_VAR_proxmox_api_url}" >> $GITHUB_ENV
          echo "TF_VAR_proxmox_api_token=${TF_VAR_proxmox_api_token}" >> $GITHUB_ENV
          echo "TF_VAR_ssh_public_key=${TF_VAR_ssh_public_key}" >> $GITHUB_ENV
          echo "PG_CONN_STR=${PG_CONN_STR}" >> $GITHUB_ENV

      - name: Terraform Init
        working-directory: terraform
        run: terraform init -backend-config="conn_str=${PG_CONN_STR}"

      - name: Terraform Validate
        working-directory: terraform
        run: terraform validate

      - name: Terraform Plan
        working-directory: terraform
        run: terraform plan -no-color
