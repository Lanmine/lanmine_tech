# GitHub Actions workflow: Terraform init/plan/apply using secrets for backend + TF_VARs for provider vars
# Triggers: manual (workflow_dispatch) to avoid accidental runs. Adjust triggers as needed.
#
# Required repository secrets:
# - PG_CONN_STR            (postgres backend connection string)
# - PROXMOX_API_URL        (proxmox API url)
# - PROXMOX_API_TOKEN      (proxmox API token)
# - SSH_PUBLIC_KEY         (ssh public key used by your Terraform config)
#
# Notes:
# - Terraform backend values cannot use var.*; we supply conn_str at init-time via -backend-config.
# - Provider/other variables are supplied through TF_VAR_* environment variables to avoid printing them.
on:
  workflow_dispatch:

name: Terraform Init & Apply (manual)

jobs:
  terraform:
    name: Terraform
    runs-on: ubuntu-latest
    env:
      # Tell Terraform it's running in automation
      TF_IN_AUTOMATION: "true"

      # Map repo secrets to TF variables (Terraform will pick these up as variables named 'proxmox_api_url', etc.)
      TF_VAR_proxmox_api_url: ${{ secrets.PROXMOX_API_URL }}
      TF_VAR_proxmox_api_token: ${{ secrets.PROXMOX_API_TOKEN }}
      TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: "1.5.7"

      - name: Terraform Init (supply backend conn_str from secret)
        run: |
          # Provide the PostgreSQL backend connection string from the PG_CONN_STR secret.
          # This avoids putting the conn_str into code.
          terraform init -upgrade -backend-config="conn_str=${{ secrets.PG_CONN_STR }}"
        # The PG_CONN_STR secret is masked in logs by GitHub Actions. Do not echo it.

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        run: terraform plan -out=tfplan -input=false

      - name: Terraform Apply (manual run of this workflow will perform apply)
        run: terraform apply -input=false -auto-approve tfplan