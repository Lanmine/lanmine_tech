services:
  panda9000:
    build: ./panda9000
    container_name: panda9000
    restart: unless-stopped
    ports:
      - "{{ panda9000_web_port }}:8080"
    environment:
      - WHISPER_URL=http://whisper:8000
      - KOKORO_URL=http://kokoro:8880
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT}
      - AZURE_OPENAI_KEY=${AZURE_OPENAI_KEY}
      - AZURE_OPENAI_DEPLOYMENT=${AZURE_OPENAI_DEPLOYMENT}
    volumes:
      # Mount source files for live updates without rebuild
      - {{ panda9000_install_dir }}/panda9000/static:/app/static:ro
      - {{ panda9000_install_dir }}/panda9000/server.py:/app/server.py:ro
    depends_on:
      whisper:
        condition: service_started
      kokoro:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  whisper:
    image: fedirz/faster-whisper-server:latest-cpu
    container_name: panda9000-whisper
    restart: unless-stopped
    environment:
      - WHISPER__MODEL=Systran/faster-whisper-small
    volumes:
      - {{ panda9000_install_dir }}/models/whisper:/root/.cache/huggingface

  kokoro:
    image: ghcr.io/remsky/kokoro-fastapi-cpu:v0.2.2
    container_name: panda9000-kokoro
    restart: unless-stopped
    volumes:
      - {{ panda9000_install_dir }}/models/kokoro:/app/models
