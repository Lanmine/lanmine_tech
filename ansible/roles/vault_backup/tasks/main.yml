---
- name: Set timestamp for backup
  set_fact:
    backup_timestamp: "{{ ansible_date_time.iso8601_basic_short }}"

- name: Set backup filename
  set_fact:
    backup_filename: "vault-data-{{ backup_timestamp }}.tar.gz.age"
    backup_path: "{{ backup_dir }}/vault-data-{{ backup_timestamp }}.tar.gz.age"
    temp_tar: "/tmp/vault-data-{{ backup_timestamp }}.tar.gz"
    remote_tar: "/tmp/vault-data-{{ backup_timestamp }}.tar.gz"

- name: Ensure backup directory exists
  file:
    path: "{{ backup_dir }}"
    state: directory
    mode: '0755'
  delegate_to: localhost

- name: Create Vault data archive on remote host
  archive:
    path: "{{ vault_data_path }}"
    dest: "{{ remote_tar }}"
    format: gz
  become: true

- name: Download Vault data archive
  fetch:
    src: "{{ remote_tar }}"
    dest: "{{ temp_tar }}"
    flat: true

- name: Remove temporary tar on Vault server
  file:
    path: "{{ remote_tar }}"
    state: absent
  become: true

- name: Get age public key from Vault
  set_fact:
    age_pub_key: "{{ lookup('community.hashi_vault.vault_kv2_get', 'infrastructure/vault-backup', validate_certs=false).secret.age_public_key }}"
  delegate_to: localhost

- name: Encrypt data archive with age
  command: >
    age --encrypt
    --recipient {{ age_pub_key }}
    --armor
    --output {{ backup_path }}
    {{ temp_tar }}
  delegate_to: localhost

- name: Remove temporary unencrypted tar
  file:
    path: "{{ temp_tar }}"
    state: absent
  delegate_to: localhost

- name: Find all Vault backups
  find:
    paths: "{{ backup_dir }}"
    patterns: "vault-data-*.tar.gz.age"
  register: backup_files
  delegate_to: localhost

- name: Sort backups by modification time
  set_fact:
    sorted_backups: "{{ backup_files.files | sort(attribute='mtime') | map(attribute='path') | list }}"

- name: Delete old backups (keep last {{ backup_retention_count }})
  file:
    path: "{{ item }}"
    state: absent
  loop: "{{ sorted_backups[:-backup_retention_count] }}"
  when: sorted_backups | length > backup_retention_count
  delegate_to: localhost

- name: Display backup info
  debug:
    msg: "Vault backup created: {{ backup_filename }}"
