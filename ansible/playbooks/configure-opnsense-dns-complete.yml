---
- name: Configure OPNsense DNS - Complete Automation (lanmine.local + hl0.dev)
  hosts: localhost
  gather_facts: no

  tasks:
    - name: Create PHP script for lanmine.local and hl0.dev configuration
      copy:
        dest: /tmp/configure-dns-complete.php
        content: |
          <?php
          // Complete DNS configuration for OPNsense
          $config_file = '/conf/config.xml';
          $backup_file = '/conf/config.xml.pre-dns-complete-' . date('Ymd-His');

          // Load config
          $config = file_get_contents($config_file);

          // Check if already configured
          if (strpos($config, 'lanmine.local') !== false && strpos($config, 'local-zone: "hl0.dev."') !== false) {
              echo "DNS already fully configured\n";
              exit(0);
          }

          // Create backup
          copy($config_file, $backup_file);

          $custom_dns = <<<'EOF'
          # WAN Resilience - lanmine.local domain
          local-zone: "lanmine.local." static
          local-data: "vault.lanmine.local. IN A 10.0.10.21"
          local-data: "postgres.lanmine.local. IN A 10.0.10.23"
          local-data: "authentik.lanmine.local. IN A 10.0.10.25"
          local-data: "akvorado.lanmine.local. IN A 10.0.10.26"
          local-data: "n8n.lanmine.local. IN A 10.0.10.27"
          local-data: "proxmox.lanmine.local. IN A 10.0.10.5"
          local-data: "opnsense.lanmine.local. IN A 10.0.10.1"
          local-data: "grafana.lanmine.local. IN A 10.0.10.40"
          local-data: "netbox.lanmine.local. IN A 10.0.10.40"
          local-data: "argocd.lanmine.local. IN A 10.0.10.40"
          local-data: "prometheus.lanmine.local. IN A 10.0.10.40"
          local-data: "alertmanager.lanmine.local. IN A 10.0.10.40"
          local-data: "hubble.lanmine.local. IN A 10.0.10.40"
          local-data: "uptime.lanmine.local. IN A 10.0.10.40"
          local-data: "panda.lanmine.local. IN A 10.0.10.40"
          local-data: "glance.lanmine.local. IN A 10.0.10.40"
          local-data: "traefik.lanmine.local. IN A 10.0.10.40"
          local-data-ptr: "10.0.10.21 vault.lanmine.local"
          local-data-ptr: "10.0.10.23 postgres.lanmine.local"
          local-data-ptr: "10.0.10.25 authentik.lanmine.local"
          local-data-ptr: "10.0.10.26 akvorado.lanmine.local"
          local-data-ptr: "10.0.10.27 n8n.lanmine.local"
          local-data-ptr: "10.0.10.5 proxmox.lanmine.local"
          local-data-ptr: "10.0.10.1 opnsense.lanmine.local"
          local-data-ptr: "10.0.10.40 grafana.lanmine.local"

          # WAN Resilience - hl0.dev domain override (wildcard)
          local-zone: "hl0.dev." redirect
          local-data: "hl0.dev. IN A 10.0.10.40"
          EOF;

          // Add custom_options element before </advanced>
          if (strpos($config, '<custom_options>') === false) {
              $custom_element = "        <custom_options><![CDATA[" . $custom_dns . "]]></custom_options>\n      </advanced>";
              $config = str_replace('      </advanced>', $custom_element, $config);
          } else {
              // Update existing custom_options if hl0.dev not present
              if (strpos($config, 'hl0.dev') === false) {
                  $hl0dev = "\n\n# WAN Resilience - hl0.dev domain override (wildcard)\nlocal-zone: \"hl0.dev.\" redirect\nlocal-data: \"hl0.dev. IN A 10.0.10.40\"";
                  $config = str_replace(']]></custom_options>', $hl0dev . ']]></custom_options>', $config);
              }
          }

          // Write config
          file_put_contents($config_file, $config);
          echo "DNS configuration added successfully\n";
          ?>
        mode: '0644'

    - name: Copy PHP script to OPNsense
      command: scp /tmp/configure-dns-complete.php root@10.0.10.1:/tmp/

    - name: Execute PHP script on OPNsense
      command: ssh root@10.0.10.1 'php /tmp/configure-dns-complete.php'
      register: php_result

    - name: Display configuration result
      debug:
        msg: "{{ php_result.stdout }}"

    - name: Create Unbound template append
      copy:
        dest: /tmp/advanced-append.txt
        content: |

          {% if not helpers.empty('OPNsense.unboundplus.advanced.custom_options') %}
          {{ OPNsense.unboundplus.advanced.custom_options }}
          {% endif %}
        mode: '0644'

    - name: Check if template already modified
      command: ssh root@10.0.10.1 'grep -q "custom_options" /usr/local/opnsense/service/templates/OPNsense/Unbound/core/advanced.conf'
      register: template_check
      failed_when: false
      changed_when: false

    - name: Copy and append template if not modified
      block:
        - name: Copy template append to OPNsense
          command: scp /tmp/advanced-append.txt root@10.0.10.1:/tmp/

        - name: Append to Unbound template
          command: ssh root@10.0.10.1 'cat /tmp/advanced-append.txt >> /usr/local/opnsense/service/templates/OPNsense/Unbound/core/advanced.conf'
      when: template_check.rc != 0

    - name: Reload Unbound templates
      command: ssh root@10.0.10.1 'configctl template reload OPNsense/Unbound'
      register: reload_result
      failed_when: false

    - name: Restart Unbound service
      command: ssh root@10.0.10.1 'configctl unbound restart'
      register: restart_result

    - name: Wait for Unbound to start
      pause:
        seconds: 5

    - name: Test lanmine.local resolution
      command: dig +short grafana.lanmine.local @10.0.10.1
      register: lanmine_test
      changed_when: false

    - name: Test hl0.dev resolution
      command: dig +short grafana.hl0.dev @10.0.10.1
      register: hl0dev_test
      changed_when: false

    - name: Display test results
      debug:
        msg: |
          ✓ grafana.lanmine.local → {{ lanmine_test.stdout }}
          ✓ grafana.hl0.dev → {{ hl0dev_test.stdout }}

    - name: Verify DNS configuration
      assert:
        that:
          - lanmine_test.stdout == '10.0.10.40'
          - hl0dev_test.stdout == '10.0.10.40'
        success_msg: "✓ Phase 1 DNS configuration COMPLETE!"
        fail_msg: "✗ DNS resolution verification failed"
