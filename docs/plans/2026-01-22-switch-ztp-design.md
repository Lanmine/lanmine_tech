# Zero Touch Provisioning for Cisco Switches Design

**Date:** 2026-01-22
**Status:** Design Complete, Ready for Implementation

## Overview

Implement fully automated zero touch provisioning (ZTP) system for Cisco network switches using Ansible, TFTP, and existing infrastructure. When any switch (Nexus 9100 core or IOS edge) powers on, it automatically receives configuration and becomes production-ready without manual intervention.

## Goals

1. Fully automatic switch provisioning from first boot to production
2. Centralized configuration management with version control
3. Enhanced monitoring with SNMP, configuration backups, and drift detection
4. Centralized authentication via TACACS+ and Authentik SSO
5. Network inventory management with NetBox as source of truth
6. Secure management VLAN isolated from infrastructure services

## Architecture

### VLAN 99 - Switch Management Network

**Network:** 10.0.99.0/24

Dedicated network for switch management traffic only, isolated from VLAN 10 (Infrastructure) for security.

**Purpose:**
- Edge switches never see VLAN 10 (vault, postgres, kubernetes, etc.)
- Limits attack surface if edge switch is compromised
- Trunked only to core switches and ubuntu-mgmt01

**Services:**
- Gateway: 10.0.99.1 (OPNsense)
- DHCP: OPNsense Kea (pool 10.0.99.100-200)
- ZTP Server: 10.0.99.20 (ubuntu-mgmt01)
- Core switches: 10.0.99.11, 10.0.99.12
- Management switches: 10.0.99.101+

### ZTP Infrastructure (ubuntu-mgmt01)

**IP Address:** 10.0.99.20 (static on VLAN 99 interface)

**Services:**

1. **atftpd (TFTP Server)**
   - Root: `/srv/tftp/`
   - Port: UDP 69
   - Serves ZTP bootstrap configs generated by Ansible
   - Read-only mode

2. **nginx (HTTP Server)**
   - Root: `/srv/http/switches/`
   - Serves large files (IOS images if needed)
   - Hosts Oxidized web UI

3. **Oxidized (Config Backup)**
   - Git repository: `/var/lib/oxidized/configs.git/`
   - Polls switches hourly via SSH
   - Detects configuration drift
   - Integrates with NetBox for device inventory

4. **TACACS+ Server (tac_plus)**
   - Docker container
   - LDAP backend to Authentik (10.0.10.25)
   - Centralized authentication and command accounting
   - Port: TCP 49

### OPNsense DHCP (VLAN 99)

**Kea DHCP Configuration:**
- Pool: 10.0.99.100-10.0.99.200
- Gateway: 10.0.99.1
- DNS: 10.0.99.1
- **Option 150:** 10.0.99.20 (TFTP server for Cisco)
- **Option 66:** 10.0.99.20 (alternate TFTP)
- Static reservations for known switches based on MAC address

### Kubernetes Services

**NetBox (Source of Truth)**
- Namespace: `netbox`
- Database: PostgreSQL (postgres-01 or dedicated)
- Redis: caching
- Storage: Longhorn
- Ingress:
  - https://netbox.hl0.dev (Cloudflare DNS + Let's Encrypt)
  - https://netbox.lionfish-caiman.ts.net (Tailscale)
- Purpose: Network inventory, IPAM, DCIM, cable management
- Integration: Ansible dynamic inventory, Oxidized device list

**Prometheus SNMP Exporter**
- Namespace: `monitoring`
- Deployment: `snmp-exporter`
- ConfigMap: Cisco IOS/NX-OS MIBs
- ServiceMonitor: scrapes switches every 30s
- Metrics: traffic, errors, CPU, memory, temperature, fans, power

**Grafana Dashboards**
- Network Overview (topology with live status)
- Switch Health (CPU/memory/temperature)
- Interface Statistics (traffic/errors/utilization)
- Environmental (power supplies, fans, alerts)

## ZTP Workflow

### Phase 1: Initial Boot (Zero Touch)

1. **Switch powers on with factory defaults**
2. **DHCP Discovery**
   - Switch broadcasts DHCP discover on all interfaces
   - OPNsense Kea responds on VLAN 99 with:
     - IP address from pool (10.0.99.100-200)
     - Gateway: 10.0.99.1
     - Option 150 (TFTP): 10.0.99.20

3. **TFTP Config Download**
   - **Cisco IOS**: Requests `network-confg` or `cisconet.cfg`
   - **Nexus NX-OS**: Requests `conf.<serial-number>` (e.g., `conf.FDO12345678`)
   - TFTP server serves bootstrap config

4. **Bootstrap Config Applied**
   - Hostname (from inventory MAC → hostname lookup)
   - Management VLAN 99 with static IP
   - Enable secret (from Vault)
   - SSH enabled with RSA keys
   - Admin user `ansible` (password from Vault)
   - Default gateway 10.0.99.1
   - DNS servers pointing to OPNsense
   - Event manager: sends syslog to ubuntu-mgmt01 on boot complete

### Phase 2: Ansible Takeover (5 minutes after boot)

5. **Switch announces itself**
   - Syslog to ubuntu-mgmt01: "Boot complete, hostname=edge-sw-02"
   - Webhook or systemd timer triggers Ansible playbook

6. **Ansible deploys full golden config**
   - Playbook: `provision-new-switch.yml`
   - Connects via SSH using ansible user
   - Deploys template based on role (core/edge/access)
   - Configuration includes:
     - VLANs, trunks, access ports
     - Routing (OSPF for core, static for edge)
     - SNMP v3, syslog to Loki
     - NTP, DNS
     - TACACS+ authentication
     - Port security, DHCP snooping, storm control

7. **Switch reboots with production config**

8. **Final validation**
   - Ansible runs show commands
   - Confirms state matches expected
   - Updates NetBox with serial number and software version

### Pre-requisite: Device Registration

Before switch arrives, admin commits to Git:

```yaml
# ansible/inventory/switches.yml
- hostname: core-sw-01
  mac: aa:bb:cc:dd:ee:01
  serial: FDO12340001
  model: nexus-9336c
  role: core
  mgmt_ip: 10.0.99.11
  vlans: [10, 20, 30, 99]

- hostname: edge-sw-01
  mac: bb:cc:dd:ee:ff:02
  serial: FDO98765432
  model: catalyst-2960x
  role: edge
  mgmt_ip: 10.0.99.101
  vlans: [20, 99]  # Contestants + Management only
```

Ansible playbook generates ZTP config and places on TFTP server at expected path.

## Configuration Templates

### Template Structure

```
ansible/
├── templates/switches/
│   ├── core-nexus.j2          # Nexus 9100 core switches
│   ├── edge-ios.j2            # IOS edge switches
│   └── ztp-bootstrap.j2       # Minimal ZTP config (all platforms)
├── files/switch-configs/
│   └── ztp/                   # Generated ZTP configs served via TFTP
│       ├── conf.FDO12340001   # Nexus serial-based
│       ├── conf.FDO12340002
│       └── network-confg      # IOS default filename
└── inventory/
    └── switches.yml           # Device inventory database
```

### ZTP Bootstrap Template (ztp-bootstrap.j2)

Minimal config to establish management connectivity:
- Hostname from inventory
- Management VLAN 99 with static IP
- Enable password (from Vault `switches/global/enable_secret`)
- SSH enabled with RSA 2048 keys
- Admin user `ansible` for automation (password from Vault)
- Default gateway 10.0.99.1
- DNS servers (OPNsense)
- Event manager applet: sends syslog on boot complete

### Core Nexus Template (core-nexus.j2)

Production config for Nexus 9100 cores:
- **vPC configuration:**
  - Domain ID: 1
  - Peer-link: port-channel (2×40G or 4×10G)
  - Peer-keepalive: VLAN 99 (management)
  - Role priority: core-sw-01 primary, core-sw-02 secondary
- **VLANs:** 10, 20, 30, 99
- **Port-channels:** LAG to downstream (e.g., ubuntu-mgmt02 2×10G LACP)
- **L3 interfaces:** SVIs with HSRP (future)
- **Routing:** OSPF (future)
- **QoS:** Traffic prioritization policies
- **SNMP v3:** credentials from Vault
- **Syslog:** forward to Loki
- **TACACS+:** authentication server 10.0.99.20

### Edge IOS Template (edge-ios.j2)

Lightweight config for access switches:
- **VLANs:** Local access VLANs + VLAN 99 (management only)
- **Trunk ports:** to core (tagged VLANs)
- **Access ports:** with port-security (max 2-3 MAC addresses)
- **Routing:** Static default route to 10.0.99.1
- **Security:**
  - DHCP snooping
  - Storm control (broadcast/multicast)
  - IP source guard
- **Monitoring:** SNMP v3, syslog

## Network Topology

### Core Layer (Nexus 9100 vPC Pair)

```
core-sw-01 (10.0.99.11) ←→ vPC peer-link ←→ core-sw-02 (10.0.99.12)
    ↓ (vPC)                                      ↓ (vPC)
    └──────────── LAG to downstream ─────────────┘
```

**vPC Configuration:**
- Domain ID: 1
- Peer-keepalive: VLAN 99 (10.0.99.11 ↔ 10.0.99.12)
- Peer-link: 2×40G or 4×10G port-channel (dedicated VLAN trunk)
- Role priority: core-sw-01 (primary), core-sw-02 (secondary)

### Downlink Connections

1. **ubuntu-mgmt02 (LANcache)** - 2×10G LACP bond
   - core-sw-01: Eth1/1 + core-sw-02: Eth1/1 → bond0 (vPC)
   - VLANs: 20 (Contestants), 99 (Management)
   - Speed: 20 Gbps aggregate

2. **OPNsense** - 2×10G or 2×1G
   - Uplink to cores (all VLANs tagged: 10, 20, 30, 99)
   - Currently: igb2 (trunk), igb3

3. **Proxmox** - 1G or 10G
   - Management interface + VM bridges
   - VLANs: 10, 99

4. **Edge Switches** - 1G or 10G uplinks
   - mgmt-sw-01 (10.0.10.101 → will migrate to 10.0.99.101)
   - Future edge switches as deployed
   - Trunk: Local VLANs + VLAN 99

### VLAN Distribution

| VLAN | Network | Gateway (Current) | Core SVI IPs (Future) |
|------|---------|-------------------|----------------------|
| 10 | 10.0.10.0/24 | 10.0.10.1 (OPNsense) | 10.0.10.11, 10.0.10.12 (HSRP VIP .1) |
| 20 | 10.0.20.0/23 | 10.0.20.1 (OPNsense) | 10.0.20.11, 10.0.20.12 (HSRP VIP .1) |
| 30 | 10.0.30.0/24 | 10.0.30.1 (OPNsense) | 10.0.30.11, 10.0.30.12 (HSRP VIP .1) |
| 99 | 10.0.99.0/24 | 10.0.99.1 (OPNsense) | 10.0.99.11, 10.0.99.12 |

**Future L3 Migration (Optional):**
- Move inter-VLAN routing from OPNsense to core switches (HSRP on SVIs)
- OPNsense becomes pure firewall (no routing, just NAT and policy)
- OSPF between cores and OPNsense for WAN routes
- Benefits: Lower latency, higher throughput for inter-VLAN traffic

## Security & Secrets Management

### Vault Secret Structure

```
secret/infrastructure/switches/
├── global
│   ├── enable_secret          # Shared enable password (privilege 15)
│   ├── snmp_v3_auth_pass     # SNMP authentication password
│   ├── snmp_v3_priv_pass     # SNMP privacy password
│   └── ansible_password       # Automation user password
├── tacacs
│   ├── shared_key            # TACACS+ server shared secret
│   └── ldap_bind_password    # Authentik LDAP bind password
└── oxidized
    └── ssh_key               # Private key for config backups
```

### Switch User Accounts

**1. Local Emergency Account** (in ZTP bootstrap)
- Username: `localadmin`
- Password: from Vault `switches/global/ansible_password`
- Privilege: 15 (full access)
- Purpose: Only used if TACACS+ is down

**2. Ansible Automation Account**
- Username: `ansible`
- Password: from Vault
- SSH key authentication preferred
- Privilege: 15 for configuration changes
- Used by: Ansible playbooks, Oxidized backups

**3. TACACS+ Authenticated Users**
- Username: Authentik users (existing SSO)
- Groups mapped to privilege levels:
  - `network-admins` → Privilege 15 (full access, all commands)
  - `network-operators` → Privilege 7 (read-only + safe commands)
  - `network-viewers` → Privilege 1 (show commands only)
- Accounting: all commands logged to syslog

### Network Security

**VLAN 99 Access Control:**
- Only ubuntu-mgmt01, NetBox, and jump hosts can SSH to switches
- OPNsense firewall rules restrict access
- Rate limiting on SSH (max 3 connections/minute)

**Switch Security Features:**
- **SNMP v3 only:** No v1/v2c, encrypted community strings
- **SSH only:** Telnet disabled globally, minimum SSH version 2
- **Port security:** MAC address limits on access ports (2-3 max)
- **DHCP snooping:** Prevent rogue DHCP servers on edge switches
- **Storm control:** Broadcast/multicast rate limiting
- **IP source guard:** Prevent IP spoofing on access ports

### Configuration Drift Detection

**Oxidized Monitoring:**
- Polls switches every hour via SSH
- Downloads running-config
- Git commits any changes with timestamp and switch hostname
- Detects manual changes (configuration drift)

**Alert Workflow:**
- Drift detected → webhook to n8n
- n8n workflow options:
  1. Notify in Slack/Discord/Teams
  2. Auto-revert to golden config (aggressive mode)
  3. Create GitHub issue for review (conservative mode)

## Deployment Strategy

### Stage 1: Infrastructure Preparation (No switch changes)

Build ZTP infrastructure without touching production switches:

1. **ubuntu-mgmt01 setup:**
   - Install atftpd, nginx
   - Create `/srv/tftp/` and `/srv/http/switches/`
   - Add VLAN 99 interface (currently unused)

2. **Ansible development:**
   - Create roles and templates in Git
   - Test template generation locally
   - Setup Vault secrets structure

3. **OPNsense configuration:**
   - Create VLAN 99 interface (10.0.99.1)
   - Configure Kea DHCP pool with options 150/66
   - Add firewall rules for VLAN 99

4. **Kubernetes deployments:**
   - Deploy NetBox
   - Deploy SNMP exporter
   - Create Grafana dashboards

5. **Test with spare switch (if available)**

### Stage 2: Core Switch Deployment (New hardware)

When Nexus 9100 switches arrive with power:

1. **Physical setup:**
   - Rack and power both cores
   - Connect peer-link cables (40G DAC or 10G DAC×4)
   - Connect peer-keepalive (1G management interface)
   - Connect uplink to OPNsense (for DHCP/ZTP on VLAN 99)

2. **ZTP process:**
   - Power on switches
   - ZTP automatically provisions (5-10 minutes)
   - Switches get 10.0.99.11 and 10.0.99.12
   - Ansible deploys full config (vPC, VLANs, trunks)

3. **Validation:**
   - Verify vPC peer-link UP
   - Verify all VLANs present
   - Test connectivity between cores
   - Cores become new backbone (not yet carrying production traffic)

### Stage 3: Migration Day (Controlled cutover)

Once cores are stable:

1. **Connect production devices to cores:**
   - One VLAN at a time for controlled migration
   - Start with VLAN 20 (Contestants) - lowest risk
   - Then VLAN 30 (OOB)
   - Finally VLAN 10 (Infrastructure) when confident

2. **Reconfigure mgmt-sw01:**
   - Factory reset
   - ZTP provisions as edge switch
   - New IP: 10.0.99.101 (from 10.0.10.101)
   - Role changes from infrastructure to edge

3. **Decommission old infrastructure**

### Stage 4: Edge Expansion

Add new edge switches as they arrive:
- Register in Git inventory
- Generate ZTP config
- Power on switch
- Fully automatic ZTP
- No manual configuration required

## Testing & Validation

### Pre-Deployment Tests

**1. TFTP Server Test:**
```bash
# From another machine on VLAN 99
tftp 10.0.99.20
get network-confg
# Should download test config
```

**2. DHCP Test:**
```bash
# Verify OPNsense DHCP pool
curl https://10.0.10.1/api/kea/dhcpv4/leases
# Check option 150 in DHCP offer (packet capture)
```

**3. Ansible Connectivity:**
```bash
ansible switches -m ping -i inventory/switches.yml
# Should connect to mgmt-sw01 (once in inventory)
```

**4. Vault Secret Retrieval:**
```bash
ansible-playbook test-vault-secrets.yml
# Validates Vault integration works
```

### ZTP Validation (Spare switch test)

1. Factory reset test switch
2. Connect to network with VLAN 99 access
3. Power on, monitor timeline:
   - ~30 seconds: DHCP lease appears in OPNsense
   - ~1 minute: TFTP download logged on ubuntu-mgmt01
   - ~2 minutes: SSH becomes available
   - ~5 minutes: Ansible playbook triggers
   - ~10 minutes: Final config applied, switch reboots

4. Validate final state:
   ```bash
   ssh admin@<switch-ip>
   show running-config
   show vlan
   show interface status
   show ip route
   ```

### Production Validation Checklist

After deploying cores:

- [ ] vPC peer-link status: `show vpc`
- [ ] vPC consistency check: `show vpc consistency-parameters global`
- [ ] All VLANs present: `show vlan brief`
- [ ] HSRP status (if L3): `show hsrp brief`
- [ ] Interface errors: `show interface | include error`
- [ ] Environmental: `show environment temperature`
- [ ] Power supplies: `show environment power`
- [ ] SNMP polling: Check Prometheus targets UP
- [ ] Oxidized backup: Verify config in Git repo
- [ ] TACACS+ login: Test SSO authentication with Authentik user
- [ ] NetBox sync: Device shows up in inventory with correct data

### Monitoring Alerts

Configure Prometheus alerts for:

**Critical:**
- Switch unreachable (SNMP poll failed for 5 minutes)
- vPC peer-link down
- Power supply failure
- High temperature (>65°C on Nexus)

**Warning:**
- High CPU usage (>80% for 5 minutes)
- High memory usage (>90%)
- Interface errors increasing (>100/min)
- Configuration drift detected (Oxidized)
- TACACS+ authentication failures

## Enhanced Monitoring Stack

### Oxidized (Configuration Backup)

**Deployment:**
- Docker container on ubuntu-mgmt01 or Kubernetes
- Configuration: `/etc/oxidized/config`
- Device list: pulled from NetBox API
- Git repository: `/var/lib/oxidized/configs.git/`

**Operation:**
- Polls switches every hour via SSH
- Downloads running-config
- Detects changes, commits to Git
- Webhook on change → n8n notification
- Web UI at http://10.0.99.20:8888

**Integration:**
- NetBox API for device inventory
- Git backend for version control
- Prometheus metrics for backup success/failure

### Prometheus SNMP Exporter

**Deployment:**
- Kubernetes namespace: `monitoring`
- ConfigMap: Cisco IOS/NX-OS MIBs

**Metrics Collected:**
- Interface traffic (bytes/packets in/out)
- Interface errors (CRC, collisions, drops)
- CPU usage (1min, 5min averages)
- Memory usage (used/free)
- Temperature sensors
- Fan speeds
- Power supply status

**ServiceMonitor:**
```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: switches-snmp
  namespace: monitoring
spec:
  endpoints:
  - port: http
    interval: 30s
    path: /snmp
    params:
      module: [cisco_ios]
    relabelings:
    - sourceLabels: [__address__]
      targetLabel: __param_target
    - sourceLabels: [__param_target]
      targetLabel: instance
    - targetLabel: __address__
      replacement: snmp-exporter:9116
  selector:
    matchLabels:
      app: snmp-exporter
```

### NetBox (Source of Truth)

**Purpose:**
- Network inventory database
- IPAM (IP address management)
- DCIM (datacenter infrastructure management)
- Cable/circuit tracking
- Rack elevation diagrams

**Data Stored:**
- Devices: switches, routers, servers
- IP addresses and subnets
- VLANs and VLAN groups
- Cables and connections
- Power distribution
- Serial numbers, asset tags

**Integrations:**
- Ansible dynamic inventory: `ansible-inventory -i netbox.yml --list`
- Oxidized device list via API
- SNMP exporter targets via API
- Custom scripts for ZTP registration

**Access:**
- Web UI: https://netbox.hl0.dev
- Tailscale: https://netbox.lionfish-caiman.ts.net
- API: https://netbox.hl0.dev/api/

### TACACS+ with Authentik

**Architecture:**
```
User → SSH to switch → TACACS+ (ubuntu-mgmt01) → Authentik LDAP → User database
```

**TACACS+ Server (tac_plus):**
- Docker container: `dchidell/docker-tacacs`
- Config: `/etc/tacacs/tac_plus.conf`
- Shared secret: from Vault `switches/tacacs/shared_key`
- Backend: LDAP pointing to Authentik (10.0.10.25:389)
- Port: TCP 49

**Authentik Configuration:**
- LDAP provider for TACACS+
- Groups: `network-admins`, `network-operators`, `network-viewers`
- User attributes passed to TACACS+
- MFA enforcement (optional)

**Authorization Mapping:**
```
network-admins → privilege 15 (full access)
network-operators → privilege 7 (read-only + safe commands)
network-viewers → privilege 1 (show commands only)
```

**Accounting:**
- All commands logged to syslog
- Forwarded to Loki for searching
- Audit trail: who ran what command, when

### Grafana Dashboards

**Network Overview Dashboard:**
- Topology diagram with status indicators
- Total switches online/offline
- Aggregate bandwidth usage
- Recent configuration changes (Oxidized)

**Switch Health Dashboard:**
- CPU usage per switch (gauge + graph)
- Memory usage per switch
- Temperature sensors (with alerts)
- Uptime

**Interface Statistics Dashboard:**
- Traffic graphs (bits/sec)
- Error rates (CRC, collisions, drops)
- Utilization heatmap
- Top talkers by interface

**Environmental Dashboard:**
- Temperature trends
- Fan speeds
- Power supply status
- Voltage/current readings

## File Structure

```
ansible/
├── roles/
│   ├── ztp-server/              # Setup ubuntu-mgmt01 ZTP services
│   │   ├── tasks/
│   │   │   ├── main.yml
│   │   │   ├── tftp.yml
│   │   │   ├── nginx.yml
│   │   │   └── vlan99.yml
│   │   └── templates/
│   │       └── atftpd.conf.j2
│   ├── oxidized/                # Oxidized backup service
│   ├── tacacs/                  # TACACS+ server setup
│   └── switch-provision/        # Switch configuration deployment
│       ├── tasks/
│       │   ├── main.yml
│       │   ├── ios.yml
│       │   └── nxos.yml
│       └── templates/
│           ├── core-nexus.j2
│           ├── edge-ios.j2
│           └── ztp-bootstrap.j2
├── playbooks/
│   ├── setup-ztp-server.yml     # Deploy ZTP infrastructure
│   ├── generate-ztp-configs.yml # Generate TFTP bootstrap configs
│   ├── provision-new-switch.yml # Full config deployment
│   └── backup-switch-configs.yml
├── inventory/
│   ├── switches.yml             # Static switch inventory
│   └── netbox.yml              # Dynamic inventory from NetBox
├── files/
│   └── switch-configs/
│       └── ztp/                # Generated ZTP configs (served via TFTP)
└── templates/
    └── switches/               # Jinja2 templates (see above)

kubernetes/
├── apps/
│   └── netbox/
│       ├── namespace.yaml
│       ├── postgres.yaml
│       ├── redis.yaml
│       ├── deployment.yaml
│       ├── service.yaml
│       ├── ingress-cloudflare.yaml
│       ├── ingress-tailscale.yaml
│       └── kustomization.yaml
└── infrastructure/
    └── monitoring/
        ├── snmp-exporter/
        │   ├── configmap.yaml  # Cisco MIBs
        │   ├── deployment.yaml
        │   ├── service.yaml
        │   └── servicemonitor.yaml
        └── grafana-dashboards/
            ├── network-overview.yaml
            ├── switch-health.yaml
            ├── interface-stats.yaml
            └── environmental.yaml
```

## Implementation Files

**New files to create:**

```
ansible/roles/ztp-server/
ansible/roles/oxidized/
ansible/roles/tacacs/
ansible/roles/switch-provision/
ansible/playbooks/setup-ztp-server.yml
ansible/playbooks/generate-ztp-configs.yml
ansible/playbooks/provision-new-switch.yml
ansible/inventory/switches.yml
ansible/templates/switches/core-nexus.j2
ansible/templates/switches/edge-ios.j2
ansible/templates/switches/ztp-bootstrap.j2

kubernetes/apps/netbox/
kubernetes/infrastructure/monitoring/snmp-exporter/
kubernetes/infrastructure/monitoring/grafana-dashboards/
```

**Updated files:**

```
CLAUDE.md (add switch management section)
ansible/inventory/hosts.yml (add ubuntu-mgmt01 VLAN 99 interface)
```

## Success Criteria

- [ ] VLAN 99 operational on OPNsense with DHCP pool
- [ ] ubuntu-mgmt01 serving TFTP and HTTP on VLAN 99
- [ ] Spare switch successfully provisions via ZTP (end-to-end test)
- [ ] Both Nexus cores provision and form vPC pair
- [ ] vPC peer-link UP with all VLANs
- [ ] SNMP exporter scraping switches, metrics in Prometheus
- [ ] Grafana dashboards showing switch health and traffic
- [ ] Oxidized backing up configs to Git hourly
- [ ] TACACS+ authentication working with Authentik SSO
- [ ] NetBox populated with switch inventory
- [ ] Configuration drift detection alerting via n8n
- [ ] Edge switches provision automatically without manual config
- [ ] mgmt-sw01 migrated to VLAN 99 without infrastructure downtime

## Future Enhancements

- **STP root bridge optimization:** Configure cores as root for all VLANs
- **Layer 3 migration:** Move inter-VLAN routing from OPNsense to cores (HSRP + OSPF)
- **Multicast routing:** IGMP snooping, PIM sparse mode if needed
- **NetFlow/IPFIX:** Export flow data to Akvorado for traffic analysis
- **Automated testing:** CI/CD pipeline to validate template changes before deployment
- **Compliance scanning:** Ansible playbook to audit switch configs against security baseline
- **Capacity planning:** Predict when to add switches based on interface utilization trends

## References

- Management VLAN: 99 (10.0.99.0/24)
- ZTP Server: ubuntu-mgmt01 (10.0.99.20)
- Core switches: 10.0.99.11, 10.0.99.12
- Vault path: `secret/infrastructure/switches/`
- NetBox: https://netbox.hl0.dev
- Oxidized: http://10.0.99.20:8888
- TACACS+ port: TCP 49
- Cisco ZTP: https://www.cisco.com/c/en/us/td/docs/switches/datacenter/nexus9000/sw/7-x/fundamentals/configuration/guide/b_Cisco_Nexus_9000_Series_NX-OS_Fundamentals_Configuration_Guide_7x/b_Cisco_Nexus_9000_Series_NX-OS_Fundamentals_Configuration_Guide_7x_chapter_0100.html
